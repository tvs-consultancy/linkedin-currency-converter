name: Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - run: npm ci

      - run: npm test

  deploy:
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - run: npm ci

      - run: npm run deploy
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

      - name: Smoke test - health check
        run: |
          STATUS=$(curl -sL -o /dev/null -w '%{http_code}' 'https://linkedin-currency-converter.tvs-consult.workers.dev/convert?amount=1&from=USD&to=EUR')
          if [ "$STATUS" != "200" ]; then
            echo "Health check failed with status $STATUS"
            exit 1
          fi

      - name: Smoke test - response validation
        run: |
          RESPONSE=$(curl -sL 'https://linkedin-currency-converter.tvs-consult.workers.dev/convert?amount=100&from=USD&to=EUR')
          echo "$RESPONSE"
          echo "$RESPONSE" | jq -e '.from == "USD"' > /dev/null
          echo "$RESPONSE" | jq -e '.to == "EUR"' > /dev/null
          echo "$RESPONSE" | jq -e '.amount == 100' > /dev/null
          echo "$RESPONSE" | jq -e '.convertedAmount > 0' > /dev/null
          echo "$RESPONSE" | jq -e '.rate > 0' > /dev/null
          echo "$RESPONSE" | jq -e '.description' > /dev/null

      - name: Smoke test - error handling
        run: |
          STATUS=$(curl -sL -o /dev/null -w '%{http_code}' 'https://linkedin-currency-converter.tvs-consult.workers.dev/convert')
          if [ "$STATUS" != "400" ]; then
            echo "Expected 400 for missing params, got $STATUS"
            exit 1
          fi
